- name: Init Swap
  shell: |
    set -e
    export LANG=C

    existing=$(free --giga | awk '/^Swap:/ { print $2 }')
    [ $existing -ge {{ swapsize }} ] && exit

    swapsize=$(({{ swapsize }} - $existing))
    swapfile=/swapfile.zs
    fallocate -l ${swapsize}G $swapfile
    dd if=/dev/zero of=$swapfile bs=1024 count=$(($swapsize*1048576)) 2>/dev/null
    chmod 600 $swapfile
    mkswap $swapfile
    swapon $swapfile
    echo $swapfile swap swap defaults 0 0 >> /etc/fstab
  args:
    creates: /swapfile.zs
